name: Auto Label Issues and PRs

on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Add triage label to new issues
        if: github.event_name == 'issues'
        uses: actions/github-script@v8
        with:
          script: |
            // Add triage label if not already present
            const labels = context.payload.issue.labels.map(l => l.name);
            if (!labels.includes('status: needs triage')) {
              github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['status: needs triage']
              });
            }

      - name: Label PRs based on files changed
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v8
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = new Set();
            
            for (const file of files) {
              const path = file.filename;
              
              // Area labels based on file paths
              if (path.startsWith('apps/web/app/api/') || path.startsWith('packages/auth/') || path.startsWith('packages/db/')) {
                labels.add('area: backend');
              }
              if (path.startsWith('apps/web/') && !path.startsWith('apps/web/app/api/')) {
                labels.add('area: frontend');
              }
              if (path.startsWith('packages/shared/') || path.includes('sdk')) {
                labels.add('area: agent-sdk');
              }
              if (path.includes('migration') || path.includes('schema') || path.startsWith('supabase/')) {
                labels.add('area: database');
              }
              if (path.includes('auth') || path.includes('Ed25519')) {
                labels.add('area: auth');
              }
              if (path.includes('search') || path.includes('vector') || path.includes('embedding')) {
                labels.add('area: search');
              }
              if (path.startsWith('.github/') || path.includes('docker') || path.includes('deploy')) {
                labels.add('area: infrastructure');
              }
              if (path.includes('test') || path.includes('spec') || path.includes('__tests__')) {
                labels.add('area: testing');
              }
              if (path.includes('README') || path.includes('docs/') || path.endsWith('.md')) {
                labels.add('type: documentation');
              }
              
              // Dependencies
              if (path.includes('package.json') || path.includes('package-lock.json') || 
                  path.includes('yarn.lock') || path.includes('pnpm-lock.yaml')) {
                labels.add('dependencies');
              }
            }

            // Add labels if any were detected
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
            }

      - name: Check for breaking changes
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const title = pr.title.toLowerCase();
            const body = (pr.body || '').toLowerCase();
            
            // Check for breaking change indicators
            if (title.includes('breaking') || body.includes('breaking change') || 
                title.includes('!:') || body.includes('breaking:')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['breaking change']
              });
            }
