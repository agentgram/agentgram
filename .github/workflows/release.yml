name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: notes
        run: |
          echo "# Release ${{ steps.version.outputs.tag }}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          if [ -n "${{ steps.prev.outputs.prev_tag }}" ]; then
            echo "## Changes since ${{ steps.prev.outputs.prev_tag }}" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            # Categorize commits
            echo "### âœ¨ Features" >> RELEASE_NOTES.md
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^feat" >> RELEASE_NOTES.md || echo "_No new features_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            echo "### ðŸ› Bug Fixes" >> RELEASE_NOTES.md
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^fix" >> RELEASE_NOTES.md || echo "_No bug fixes_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            echo "### ðŸ“š Documentation" >> RELEASE_NOTES.md
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^docs" >> RELEASE_NOTES.md || echo "_No documentation changes_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            echo "### â™»ï¸ Refactoring" >> RELEASE_NOTES.md
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^refactor" >> RELEASE_NOTES.md || echo "_No refactoring_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            echo "### ðŸ”’ Security" >> RELEASE_NOTES.md
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^security" >> RELEASE_NOTES.md || echo "_No security updates_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            echo "### ðŸš¨ Breaking Changes" >> RELEASE_NOTES.md
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="BREAKING" >> RELEASE_NOTES.md || echo "_No breaking changes_" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          else
            echo "## Initial Release" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "This is the first release of AgentGram! ðŸŽ‰" >> RELEASE_NOTES.md
          fi
          
          # Add full commit list
          echo "---" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### All Commits" >> RELEASE_NOTES.md
          if [ -n "${{ steps.prev.outputs.prev_tag }}" ]; then
            git log ${{ steps.prev.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges >> RELEASE_NOTES.md
          fi
          
          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Build & Push Docker Image
      # Uncomment when ready to deploy
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3
      # 
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      # 
      # - name: Build and push
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     push: true
      #     tags: |
      #       agentgram/agentgram:${{ steps.version.outputs.version }}
      #       agentgram/agentgram:latest
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # Optional: Deploy to production
      # - name: Trigger Deployment
      #   run: |
      #     curl -X POST ${{ secrets.DEPLOY_WEBHOOK_URL }} \
      #       -H "Content-Type: application/json" \
      #       -d '{"version": "${{ steps.version.outputs.version }}"}'

      - name: Notify Success
        run: |
          echo "âœ… Release ${{ steps.version.outputs.tag }} published successfully!"
          echo "ðŸ“¦ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
